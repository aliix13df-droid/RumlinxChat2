<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VyxChat Pro + Status</title>
    <style>
        :root { --primary: #008069; --bg: #d1d7db; --surface: #fff; --text: #111b21; --msg-sent: #dcf8c6; --msg-rec: #fff; --chat-bg: #efe7dd; --status-ring: #25d366; }
        [data-theme="dark"] { --primary: #202c33; --bg: #111b21; --surface: #202c33; --text: #e9edef; --msg-sent: #005c4b; --msg-rec: #202c33; --chat-bg: #0b141a; --status-ring: #00a884; }
        * { box-sizing: border-box; font-family: -apple-system, sans-serif; }
        body { margin: 0; background-color: var(--bg); height: 100vh; display: flex; justify-content: center; }
        #app { width: 100%; max-width: 450px; background: var(--surface); display: flex; flex-direction: column; height: 100%; position: relative; overflow: hidden; }
        
        header { background: var(--primary); color: white; padding: 10px 15px; display: flex; align-items: center; gap: 10px; height: 60px; z-index: 10; }
        #back-btn { display: none; background: none; border: none; color: white; font-size: 20px; cursor: pointer; }
        .header-info { flex: 1; }

        /* DURUM (STATUS) BAR */
        .status-bar { display: flex; gap: 15px; padding: 15px; overflow-x: auto; background: var(--surface); border-bottom: 1px solid rgba(0,0,0,0.1); scrollbar-width: none; }
        .status-bar::-webkit-scrollbar { display: none; }
        .status-item { display: flex; flex-direction: column; align-items: center; min-width: 65px; cursor: pointer; }
        .status-circle { width: 55px; height: 55px; border-radius: 50%; padding: 2px; border: 2.5px solid #ccc; display: flex; align-items: center; justify-content: center; position: relative; }
        .status-circle.active { border-color: var(--status-ring); }
        .status-avatar { width: 100%; height: 100%; background: #667781; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; }
        .status-name { font-size: 11px; margin-top: 5px; color: var(--text); max-width: 65px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .add-status { position: absolute; bottom: 0; right: 0; width: 18px; height: 18px; background: var(--status-ring); border-radius: 50%; border: 2px solid var(--surface); color: white; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; }

        /* EKRANLAR */
        .screen { display: none; flex-direction: column; height: 100%; flex: 1; overflow: hidden; }
        .active { display: flex; }

        .user-list { flex: 1; overflow-y: auto; background: var(--surface); }
        .user-item { padding: 12px 15px; border-bottom: 1px solid rgba(0,0,0,0.05); display: flex; align-items: center; gap: 15px; cursor: pointer; color: var(--text); }
        
        /* CHAT */
        #chat-container { flex: 1; overflow-y: auto; padding: 15px; background: var(--chat-bg); background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); display: flex; flex-direction: column; gap: 8px; }
        .message { max-width: 80%; padding: 8px 12px; border-radius: 8px; font-size: 15px; position: relative; color: var(--text); box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .sent { align-self: flex-end; background: var(--msg-sent); }
        .received { align-self: flex-start; background: var(--msg-rec); }
        .msg-info { display: flex; justify-content: flex-end; align-items: center; gap: 3px; font-size: 10px; opacity: 0.6; margin-top: 3px; }

        /* DURUM G√ñR√úNT√úLEYƒ∞Cƒ∞ */
        #status-viewer { display: none; position: absolute; top:0; left:0; width:100%; height:100%; background: #000; z-index: 1000; flex-direction: column; justify-content: center; align-items: center; color: white; padding: 20px; text-align: center; }
        #status-progress { position: absolute; top: 10px; left: 5%; width: 90%; height: 3px; background: rgba(255,255,255,0.3); }
        #status-bar-fill { height: 100%; background: white; width: 0%; transition: width linear; }

        .input-area { background: var(--bg); padding: 10px; display: flex; gap: 10px; }
        #msgInput { flex: 1; border-radius: 20px; border: none; padding: 10px 15px; outline: none; }
        .send-btn { background: var(--primary); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; }
    </style>
</head>
<body>

<div id="app">
    <header>
        <button id="back-btn" onclick="goBack()">‚Üê</button>
        <div class="header-info">
            <b id="header-title">VyxChat Pro</b>
            <span id="header-sub" style="font-size:12px; display:block"></span>
        </div>
        <button onclick="toggleTheme()" style="background:none; border:none; color:white; font-size:20px;">üåì</button>
    </header>

    <div id="login-screen" class="screen active" style="justify-content:center; align-items:center; padding:20px;">
        <div style="background:var(--surface); padding:25px; border-radius:15px; width:100%; text-align:center;">
            <h2 style="color:var(--primary)">Ho≈ü Geldin</h2>
            <input type="text" id="usernameInput" placeholder="Kullanƒ±cƒ± Adƒ±n">
            <button class="send-btn" style="width:100%; border-radius:10px" onclick="login()">Giri≈ü Yap</button>
        </div>
    </div>

    <div id="users-screen" class="screen">
        <div class="status-bar" id="status-bar">
            <div class="status-item" onclick="postStatus()">
                <div class="status-circle"><div class="status-avatar" id="my-small-avatar">?</div><div class="add-status">+</div></div>
                <div class="status-name">Durumum</div>
            </div>
            </div>
        <div class="user-list" id="user-list"></div>
    </div>

    <div id="chat-screen" class="screen">
        <div id="chat-container"></div>
        <div class="input-area">
            <input type="text" id="msgInput" placeholder="Mesaj yaz..." autocomplete="off">
            <button class="send-btn" onclick="sendMessage()">‚û§</button>
        </div>
    </div>

    <div id="status-viewer" onclick="closeStatus()">
        <div id="status-progress"><div id="status-bar-fill"></div></div>
        <div id="status-user" style="position:absolute; top:30px; left:20px; font-weight:bold;"></div>
        <h2 id="status-content"></h2>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, setDoc, doc, updateDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDo3zkxE-4_V6qs6FQ21_x523gul5EaP7U",
        authDomain: "rumlinx.firebaseapp.com",
        projectId: "rumlinx",
        storageBucket: "rumlinx.firebasestorage.app",
        messagingSenderId: "107571707229",
        appId: "1:107571707229:web:1be9f876588c4197b8bcb4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let myName = "", chatPartner = "", chatId = "", statusTimer;

    window.toggleTheme = () => {
        const d = document.documentElement;
        d.getAttribute("data-theme") === "dark" ? d.removeAttribute("data-theme") : d.setAttribute("data-theme", "dark");
    };

    window.login = async () => {
        myName = document.getElementById('usernameInput').value.trim();
        if(!myName) return;
        await setDoc(doc(db, "users", myName), { username: myName, isOnline: true, lastLogin: serverTimestamp() }, {merge:true});
        document.getElementById('my-small-avatar').innerText = myName[0].toUpperCase();
        showScreen('users-screen');
        listenData();
    };

    // --- DURUM PAYLA≈ûMA ---
    window.postStatus = async () => {
        const text = prompt("Durumunda ne payla≈ümak istersin?");
        if(text) {
            await setDoc(doc(db, "status", myName), {
                username: myName,
                content: text,
                createdAt: Date.now() // 24 saat kontrol√º i√ßin
            });
        }
    };

    function listenData() {
        // Kullanƒ±cƒ±larƒ± Listele
        onSnapshot(collection(db, "users"), (s) => {
            const list = document.getElementById('user-list');
            list.innerHTML = "";
            s.forEach(d => {
                const u = d.data();
                if(u.username !== myName) {
                    list.innerHTML += `<div class="user-item" onclick="startChat('${u.username}')">
                        <div class="status-circle" style="width:45px; height:45px; border:none">
                            <div class="status-avatar" style="font-size:18px">${u.username[0].toUpperCase()}</div>
                        </div>
                        <div><b>${u.username}</b><br><small style="color:${u.isOnline?'#25d366':'gray'}">${u.isOnline?'√ßevrimi√ßi':'√ßevrimdƒ±≈üƒ±'}</small></div>
                    </div>`;
                }
            });
        });

        // Durumlarƒ± Listele
        onSnapshot(collection(db, "status"), (s) => {
            const bar = document.getElementById('status-bar');
            const myStatusBtn = bar.firstElementChild.outerHTML;
            bar.innerHTML = myStatusBtn;
            const now = Date.now();
            s.forEach(d => {
                const st = d.data();
                if(now - st.createdAt < 86400000) { // 24 Saat Kontrol√º
                    if(st.username !== myName) {
                        const item = document.createElement('div');
                        item.className = 'status-item';
                        item.onclick = () => viewStatus(st.username, st.content);
                        item.innerHTML = `<div class="status-circle active"><div class="status-avatar">${st.username[0].toUpperCase()}</div></div><div class="status-name">${st.username}</div>`;
                        bar.appendChild(item);
                    }
                }
            });
        });
    }

    // --- DURUM ƒ∞ZLEME ---
    window.viewStatus = (user, content) => {
        const viewer = document.getElementById('status-viewer');
        const bar = document.getElementById('status-bar-fill');
        document.getElementById('status-user').innerText = user;
        document.getElementById('status-content').innerText = content;
        viewer.style.display = 'flex';
        bar.style.width = '0%';
        setTimeout(() => { bar.style.transition = 'width 4s linear'; bar.style.width = '100%'; }, 50);
        statusTimer = setTimeout(closeStatus, 4050);
    };

    window.closeStatus = () => {
        document.getElementById('status-viewer').style.display = 'none';
        document.getElementById('status-bar-fill').style.transition = 'none';
        clearTimeout(statusTimer);
    };

    window.startChat = (p) => {
        chatPartner = p;
        chatId = [myName, p].sort().join("_");
        showScreen('chat-screen');
        document.getElementById('header-title').innerText = p;
        document.getElementById('back-btn').style.display = "block";
        listenMessages();
    };

    window.sendMessage = async () => {
        const inp = document.getElementById('msgInput');
        if(!inp.value.trim()) return;
        await addDoc(collection(db, "messages"), { chatId, sender: myName, text: inp.value, createdAt: serverTimestamp() });
        inp.value = "";
    };

    function listenMessages() {
        onSnapshot(collection(db, "messages"), (s) => {
            const cont = document.getElementById('chat-container');
            let msgs = []; s.forEach(d => msgs.push(d.data()));
            msgs.sort((a,b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
            cont.innerHTML = "";
            msgs.forEach(m => {
                if(m.chatId === chatId) {
                    const isMe = m.sender === myName;
                    cont.innerHTML += `<div class="message ${isMe?'sent':'received'}">${m.text}<div class="msg-info">‚úì‚úì</div></div>`;
                }
            });
            cont.scrollTop = cont.scrollHeight;
        });
    }

    function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    window.goBack = () => { showScreen('users-screen'); document.getElementById('back-btn').style.display="none"; };
</script>
</body>
</html>
