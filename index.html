<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Toybell V12.1 - Pro Max</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #008069; --bg: #efe7dd; --surface: #ffffff; --text: #111b21; --sent: #d9fdd3; --rec: #ffffff; --accent: #25d366; --dark-green: #075e54; --gray: #667781; }
        * { box-sizing: border-box; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; }
        body { background: #d1d7db; height: 100vh; display: flex; justify-content: center; overflow: hidden; }
        #app { width: 100%; max-width: 500px; background: var(--surface); display: flex; flex-direction: column; height: 100%; position: relative; overflow: hidden; box-shadow: 0 0 20px rgba(0,0,0,0.2); }

        /* --- HEADER & MENU --- */
        header { background: var(--primary); color: white; padding: 10px 15px; display: flex; align-items: center; justify-content: space-between; height: 60px; z-index: 100; }
        .dropdown-menu { position: absolute; top: 55px; right: 10px; background: white; color: #333; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: none; flex-direction: column; width: 170px; z-index: 500; padding: 5px 0; }
        .dropdown-menu div { padding: 12px 20px; cursor: pointer; font-size: 15px; transition: 0.2s; }
        .dropdown-menu div:hover { background: #f5f5f5; }

        /* --- TABS --- */
        .tabs { display: flex; background: var(--primary); color: rgba(255,255,255,0.7); font-weight: bold; font-size: 14px; text-transform: uppercase; z-index: 99; }
        .tab { flex: 1; padding: 15px 0; text-align: center; cursor: pointer; border-bottom: 3px solid transparent; }
        .tab.active { color: white; border-bottom: 3px solid white; }

        /* --- VIEWS --- */
        .view-section { flex: 1; overflow-y: auto; background: var(--surface); display: none; }
        .view-section.active-view { display: block; }

        /* --- LIST ITEMS --- */
        .list-item { display:flex; align-items:center; gap:15px; padding:12px 15px; cursor:pointer; border-bottom:1px solid #f0f0f0; transition: 0.2s; }
        .list-item:active { background: #f5f5f5; }
        .avatar { width:50px; height:50px; border-radius:50%; background:#dfe5e7; display:flex; align-items:center; justify-content:center; overflow:hidden; object-fit: cover; font-size: 20px; color: white; flex-shrink: 0; }

        /* --- STATUS CREATOR --- */
        #status-creator { display:none; position:fixed; top:0; left:0; width:100%; height:100%; z-index:2000; flex-direction:column; align-items:center; justify-content:center; padding:20px; transition: background 0.3s; }
        #status-text-input { background:transparent; border:none; color:white; font-size:32px; text-align:center; outline:none; width:100%; max-width:400px; resize: none; font-weight: 300; }
        #status-text-input::placeholder { color: rgba(255,255,255,0.5); }

        /* --- SCREENS --- */
        .screen { display: none; flex-direction: column; height: 100%; width:100%; position:absolute; top:0; left:0; background:var(--surface); z-index: 50; }
        .screen.active { display: flex; }
        #chat-bg { flex: 1; background: #e5ddd5 url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 5px; }

        /* --- BUBBLES --- */
        .msg { max-width: 85%; padding: 8px 12px; border-radius: 8px; font-size: 14.5px; position: relative; margin-bottom: 2px; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .msg.sent { align-self: flex-end; background: var(--sent); border-top-right-radius: 0; }
        .msg.received { align-self: flex-start; background: var(--rec); border-top-left-radius: 0; }
        .msg-time { font-size: 10px; color: var(--gray); text-align: right; margin-top: 4px; }

        /* --- FABS --- */
        .fab { position:absolute; bottom:25px; right:20px; width:56px; height:56px; background:var(--accent); border-radius:50%; color:white; display:flex; align-items:center; justify-content:center; font-size:22px; cursor:pointer; box-shadow:0 4px 10px rgba(0,0,0,0.3); z-index: 120; }
        .fab-small { bottom: 95px; width: 45px; height: 45px; background: #e9edef; color: #54656f; font-size: 18px; right: 25px; }
    </style>
</head>
<body>

<div id="app">
    <div id="main-menu" class="dropdown-menu">
        <div id="menu-profil"><i class="fas fa-user"></i> &nbsp; Profil</div>
        <div id="menu-ayarlar"><i class="fas fa-cog"></i> &nbsp; Ayarlar</div>
        <div id="menu-logout"><i class="fas fa-sign-out-alt"></i> &nbsp; √áƒ±kƒ±≈ü Yap</div>
    </div>

    <div id="status-creator" style="background: #673ab7;">
        <i class="fas fa-times" id="closeStatus" style="position:absolute; top:25px; left:25px; color:white; font-size:24px; cursor:pointer;"></i>
        <div style="position:absolute; top:25px; right:25px; display:flex; gap:25px;">
            <i class="fas fa-palette" id="changeBg" style="color:white; font-size:24px; cursor:pointer;"></i>
            <i class="fas fa-check" id="postStatus" style="color:white; font-size:24px; cursor:pointer;"></i>
        </div>
        <textarea id="status-text-input" placeholder="Bir durum yaz..." rows="4"></textarea>
    </div>

    <div id="auth-screen" class="screen active" style="background:var(--primary); justify-content:center; align-items:center; z-index:1000;">
        <div style="background:white; padding:40px; border-radius:28px; width:88%; text-align:center;">
            <h1 style="color:var(--primary); font-size:36px; margin-bottom:10px;">ùïãùï†ùï™ùïìùïñùïùùïù</h1>
            <p style="color:var(--gray); font-size:14px; margin-bottom:30px;">G√ºvenli ve Hƒ±zlƒ± Mesajla≈üma</p>
            <input type="text" id="userInput" placeholder="Kullanƒ±cƒ± Adƒ±" style="width:100%; padding:15px; margin-top:10px; border-radius:12px; border:1px solid #ddd; outline:none;">
            <input type="password" id="passInput" placeholder="≈ûifre" style="width:100%; padding:15px; margin-top:10px; border-radius:12px; border:1px solid #ddd; outline:none;">
            <button id="authBtn" style="width:100%; padding:15px; background:var(--accent); color:white; border:none; border-radius:12px; margin-top:25px; cursor:pointer; font-weight:bold; font-size:16px;">Gƒ∞Rƒ∞≈û YAP</button>
        </div>
    </div>

    <div id="main-screen" class="screen">
        <header>
            <b style="font-size:22px; letter-spacing: 0.5px;">Toybell</b>
            <div style="display:flex; gap:22px; font-size:18px;">
                <i class="fas fa-camera"></i>
                <i class="fas fa-search"></i>
                <i class="fas fa-ellipsis-v" id="threeDots" style="cursor:pointer; padding: 5px;"></i>
            </div>
        </header>
        <div class="tabs">
            <div class="tab" id="tabGroups" style="flex:0.4;"><i class="fas fa-users"></i></div>
            <div class="tab active" id="tabChats">Sohbetler</div>
            <div class="tab" id="tabStatus">Durum</div>
            <div class="tab" id="tabCalls">Aramalar</div>
        </div>

        <div id="chats-view" class="view-section active-view">
            <div class="list-item" onclick="openChat('Toybell AI')">
                <div class="avatar" style="background:#00a884;"><i class="fas fa-robot"></i></div>
                <div style="flex:1">
                    <div style="display:flex; justify-content:space-between;"><b>Toybell AI</b> <small style="color:var(--accent); font-weight:bold;">Yapay Zeka</small></div>
                    <small style="color:var(--gray)">Merhaba agam, sana nasƒ±l yardƒ±mcƒ± olabilirim?</small>
                </div>
            </div>
            <div id="chat-list"></div>
        </div>

        <div id="status-view" class="view-section">
            <div class="list-item">
                <div class="avatar" style="background:#ccc;"><i class="fas fa-user"></i></div>
                <div><b>Durumum</b><br><small style="color:var(--gray)">Durum g√ºncellemesi eklemek i√ßin dokun</small></div>
            </div>
            <p style="padding:15px; font-size:13px; color:var(--dark-green); font-weight:bold; background: #f0f2f5;">G√úNCEL DURUMLAR</p>
            <div id="status-list"></div>
        </div>

        <div id="groups-view" class="view-section">
            <div class="list-item" id="btnNewGroup">
                <div class="avatar" style="background:var(--accent)"><i class="fas fa-plus"></i></div>
                <div><b>Yeni Grup Olu≈ütur</b></div>
            </div>
            <div id="group-list" style="padding: 10px 0;"></div>
        </div>

        <div id="calls-view" class="view-section">
            <div style="padding:50px; text-align:center; color:var(--gray);">
                <i class="fas fa-phone-alt" style="font-size:40px; margin-bottom:15px; opacity:0.3;"></i>
                <p>Arama kaydƒ± bulunamadƒ±.</p>
            </div>
        </div>

        <div class="fab fab-small" id="fabStatusPen" style="display:none;"><i class="fas fa-pen"></i></div>
        <div class="fab" id="mainFab"><i class="fas fa-comment-alt"></i></div>
    </div>

    <div id="profile-screen" class="screen">
        <header>
            <div style="display:flex; align-items:center; gap:25px;">
                <i class="fas fa-arrow-left" id="closeProfile" style="cursor:pointer;"></i>
                <b style="font-size:19px;">Profil</b>
            </div>
        </header>
        <div style="flex:1; background:#f0f2f5;">
            <div style="padding:30px; text-align:center;">
                <div style="position:relative; width:160px; height:160px; margin:0 auto 25px;">
                    <img id="my-pfp" src="https://via.placeholder.com/160" style="width:100%; height:100%; border-radius:50%; object-fit:cover; border: 4px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <label for="p-file" style="position:absolute; bottom:5px; right:5px; background:var(--accent); color:white; width:42px; height:42px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; border:3px solid #f0f2f5;">
                        <i class="fas fa-camera"></i>
                    </label>
                    <input type="file" id="p-file" hidden accept="image/*">
                </div>
                <div style="background:white; padding:20px; border-radius:15px; text-align:left; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                    <small style="color:var(--primary); font-weight:bold;">Adƒ±nƒ±z</small>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:5px;">
                        <span id="display-name" style="font-size:18px;">Kullanƒ±cƒ±</span>
                        <i class="fas fa-pen" style="color:var(--gray);"></i>
                    </div>
                </div>
                <p style="margin-top:15px; color:var(--gray); font-size:13px; padding: 0 10px;">Bu isim Toybell rehberinde g√∂r√ºnecek isimdir.</p>
            </div>
        </div>
    </div>

    <div id="chat-screen" class="screen">
        <header>
            <div style="display:flex; align-items:center; gap:12px;">
                <i class="fas fa-arrow-left" id="backBtn" style="cursor:pointer; padding:5px;"></i>
                <div id="chat-pfp-box" class="avatar" style="width:38px; height:38px; font-size:15px;">?</div>
                <div style="line-height:1.2">
                    <b id="chat-name" style="font-size:16px;">Ki≈üi</b><br>
                    <small style="font-size:11px; opacity:0.9;">√ßevrimi√ßi</small>
                </div>
            </div>
            <div style="display:flex; gap:20px; font-size:17px;">
                <i class="fas fa-video"></i>
                <i class="fas fa-phone-alt"></i>
                <i class="fas fa-ellipsis-v"></i>
            </div>
        </header>
        <div id="chat-bg"></div>
        <div style="padding:8px 10px; background:#f0f2f5; display:flex; gap:8px; align-items:center;">
            <div style="flex:1; background:white; border-radius:25px; padding:4px 12px; display:flex; align-items:center; gap:10px; box-shadow: 0 1px 2px rgba(0,0,0,0.1);">
                <i class="far fa-smile" style="color:var(--gray); font-size:22px;"></i>
                <input type="text" id="msgInput" placeholder="Mesaj..." style="flex:1; border:none; padding:10px 0; outline:none; font-size:16px;">
                <i class="fas fa-paperclip" style="color:var(--gray); font-size:20px; transform: rotate(-45deg);"></i>
                <i class="fas fa-camera" style="color:var(--gray); font-size:20px;"></i>
            </div>
            <button id="sendBtn" style="background:var(--primary); color:white; border:none; width:48px; height:48px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center;">
                <i class="fas fa-paper-plane" style="font-size:18px; margin-left:2px;"></i>
            </button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, setDoc, doc, getDoc, query, orderBy, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyDo3zkxE-4_V6qs6FQ21_x523gul5EaP7U", authDomain: "rumlinx.firebaseapp.com", projectId: "rumlinx", storageBucket: "rumlinx.firebasestorage.app", messagingSenderId: "107571707229", appId: "1:107571707229:web:1be9f876588c4197b8bcb4" };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let myUser = localStorage.getItem("t_user");
    let activeChat = null;
    let usersData = {};
    const statusColors = ["#673ab7", "#2196f3", "#000000", "#e91e63", "#ff9800", "#4caf50", "#795548"];
    let currentColorIdx = 0;

    if(myUser) startApp();

    document.getElementById("authBtn").onclick = async () => {
        const u = document.getElementById("userInput").value.trim().toLowerCase();
        const p = document.getElementById("passInput").value.trim();
        if(!u || p.length < 4) return alert("Bilgileri eksiksiz gir agam!");
        const ref = doc(db, "users", u);
        const snap = await getDoc(ref);
        if(snap.exists() && snap.data().password !== p) return alert("Hatalƒ± ≈ûifre!");
        if(!snap.exists()) await setDoc(ref, { username: u, password: p, pfp: "", status: "Toybell kullanƒ±yor" });
        myUser = u;
        localStorage.setItem("t_user", u);
        startApp();
    };

    function startApp() {
        document.getElementById("auth-screen").classList.remove("active");
        document.getElementById("main-screen").classList.add("active");
        document.getElementById("display-name").innerText = myUser;
        loadGlobalData();
    }

    function loadGlobalData() {
        // Kullanƒ±cƒ± Listesi
        onSnapshot(collection(db, "users"), (snap) => {
            const list = document.getElementById("chat-list");
            list.innerHTML = "";
            snap.forEach(d => {
                const data = d.data();
                usersData[d.id] = data;
                if(d.id !== myUser) {
                    const div = document.createElement("div");
                    div.className = "list-item";
                    const pfp = data.pfp ? `<img src="${data.pfp}" class="avatar">` : `<div class="avatar">${d.id[0].toUpperCase()}</div>`;
                    div.innerHTML = `${pfp}<div style="flex:1"><b>${d.id}</b><br><small style="color:var(--gray)">${data.status || 'M√ºsait'}</small></div>`;
                    div.onclick = () => openChat(d.id);
                    list.appendChild(div);
                } else if(data.pfp) {
                    document.getElementById("my-pfp").src = data.pfp;
                }
            });
        });

        // Durumlar (Son 24 Saat)
        const dayAgo = new Date(Date.now() - 24*60*60*1000);
        const qStatus = query(collection(db, "status"), where("createdAt", ">", dayAgo), orderBy("createdAt", "desc"));
        onSnapshot(qStatus, (snap) => {
            const list = document.getElementById("status-list");
            list.innerHTML = "";
            snap.forEach(d => {
                const s = d.data();
                const div = document.createElement("div");
                div.className = "list-item";
                div.innerHTML = `<div class="avatar" style="background:${s.color}; border:2px solid var(--accent); font-size:11px; padding:4px; text-align:center; color:white;">${s.text.substring(0,6)}..</div>
                                 <div><b>${s.sender}</b><br><small style="color:var(--gray)">Bug√ºn ${new Date(s.createdAt?.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</small></div>`;
                div.onclick = () => alert(`${s.sender} diyor ki: \n\n"${s.text}"`);
                list.appendChild(div);
            });
        });

        // Gruplarƒ± Getir
        onSnapshot(collection(db, "messages"), (snap) => {
            const groups = new Set();
            snap.forEach(d => { if(d.data().chatId.startsWith("GRP_")) groups.add(d.data().chatId); });
            const gList = document.getElementById("group-list");
            gList.innerHTML = "";
            groups.forEach(gid => {
                const name = gid.replace("GRP_", "");
                const div = document.createElement("div");
                div.className = "list-item";
                div.innerHTML = `<div class="avatar" style="background:var(--dark-green)"><i class="fas fa-users"></i></div><div><b>${name}</b></div>`;
                div.onclick = () => openChat(gid);
                gList.appendChild(div);
            });
        });
    }

    // --- MENU LOGIC ---
    const menu = document.getElementById("main-menu");
    document.getElementById("threeDots").onclick = (e) => {
        e.stopPropagation();
        menu.style.display = menu.style.display === "flex" ? "none" : "flex";
    };
    window.onclick = () => menu.style.display = "none";
    document.getElementById("menu-profil").onclick = () => document.getElementById("profile-screen").classList.add("active");
    document.getElementById("closeProfile").onclick = () => document.getElementById("profile-screen").classList.remove("active");
    document.getElementById("menu-logout").onclick = () => { localStorage.removeItem("t_user"); location.reload(); };

    // --- STATUS LOGIC ---
    document.getElementById("fabStatusPen").onclick = () => document.getElementById("status-creator").style.display = "flex";
    document.getElementById("closeStatus").onclick = () => document.getElementById("status-creator").style.display = "none";
    document.getElementById("changeBg").onclick = () => {
        currentColorIdx = (currentColorIdx + 1) % statusColors.length;
        document.getElementById("status-creator").style.background = statusColors[currentColorIdx];
    };
    document.getElementById("postStatus").onclick = async () => {
        const val = document.getElementById("status-text-input").value.trim();
        if(!val) return;
        await addDoc(collection(db, "status"), { sender: myUser, text: val, color: statusColors[currentColorIdx], createdAt: serverTimestamp() });
        document.getElementById("status-creator").style.display = "none";
        document.getElementById("status-text-input").value = "";
    };

    // --- CHAT LOGIC ---
    window.openChat = function(id) {
        if(id === "Toybell AI") { activeChat = "ai_room"; document.getElementById("chat-name").innerText = "Toybell AI"; }
        else if(id.startsWith("GRP_")) { activeChat = id; document.getElementById("chat-name").innerText = id.replace("GRP_", ""); }
        else { activeChat = [myUser, id].sort().join("_"); document.getElementById("chat-name").innerText = id; }
        
        document.getElementById("chat-pfp-box").innerHTML = document.getElementById("chat-name").innerText[0].toUpperCase();
        document.getElementById("main-screen").classList.remove("active");
        document.getElementById("chat-screen").classList.add("active");
        loadMessages();
    };

    function loadMessages() {
        const q = query(collection(db, "messages"), orderBy("createdAt", "asc"));
        onSnapshot(q, (snap) => {
            const bg = document.getElementById("chat-bg");
            bg.innerHTML = "";
            snap.forEach(d => {
                const m = d.data();
                if(m.chatId === activeChat) {
                    const div = document.createElement("div");
                    const isMe = m.sender === myUser;
                    div.className = `msg ${isMe ? 'sent' : 'received'}`;
                    const time = m.createdAt ? new Date(m.createdAt.toDate()).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '--:--';
                    div.innerHTML = `<div>${m.text}</div><div class="msg-time">${time}</div>`;
                    bg.appendChild(div);
                }
            });
            bg.scrollTop = bg.scrollHeight;
        });
    }

    document.getElementById("sendBtn").onclick = async () => {
        const val = document.getElementById("msgInput").value.trim();
        if(!val) return;
        document.getElementById("msgInput").value = "";
        await addDoc(collection(db, "messages"), { chatId: activeChat, sender: myUser, text: val, createdAt: serverTimestamp() });
        if(activeChat === "ai_room") {
            setTimeout(async () => {
                await addDoc(collection(db, "messages"), { chatId: activeChat, sender: "Toybell AI", text: "Toybell AI: Dinliyorum agam, bu konuda ne yapabiliriz?", createdAt: serverTimestamp() });
            }, 1000);
        }
    };

    document.getElementById("backBtn").onclick = () => {
        document.getElementById("chat-screen").classList.remove("active");
        document.getElementById("main-screen").classList.add("active");
    };

    const tabs = ["tabGroups", "tabChats", "tabStatus", "tabCalls"];
    const views = ["groups-view", "chats-view", "status-view", "calls-view"];
    function switchTab(idx) {
        tabs.forEach((t, i) => {
            document.getElementById(t).classList.toggle("active", i === idx);
            document.getElementById(views[i]).classList.toggle("active-view", i === idx);
        });
        document.getElementById("fabStatusPen").style.display = (idx === 2) ? "flex" : "none";
        document.getElementById("mainFab").innerHTML = (idx === 2) ? '<i class="fas fa-camera"></i>' : '<i class="fas fa-comment-alt"></i>';
    }
    tabs.forEach((t, i) => document.getElementById(t).onclick = () => switchTab(i));

    document.getElementById("btnNewGroup").onclick = async () => {
        const gName = prompt("Grup ismini yaz agam:");
        if(gName) {
            const gid = "GRP_" + gName;
            await addDoc(collection(db, "messages"), { chatId: gid, sender: "Sistem", text: `${myUser} grubu olu≈üturdu.`, createdAt: serverTimestamp() });
            openChat(gid);
        }
    };

    document.getElementById("p-file").onchange = (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = async (ev) => {
            const base64 = ev.target.result;
            document.getElementById("my-pfp").src = base64;
            await setDoc(doc(db, "users", myUser), { pfp: base64 }, {merge:true});
        };
        reader.readAsDataURL(file);
    };
</script>
</body>
</html>
