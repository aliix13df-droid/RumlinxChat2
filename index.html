<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VyxChat Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #008069;
            --bg-color: #d1d7db;
            --chat-bg: #efe7dd; /* WhatsApp default */
            --header-text: #fff;
            --surface: #fff;
            --text-primary: #111b21;
            --text-secondary: #667781;
            --msg-sent: #dcf8c6;
            --msg-received: #fff;
            --input-bg: #f0f2f5;
        }

        [data-theme="dark"] {
            --primary: #202c33;
            --bg-color: #111b21;
            --chat-bg: #0b141a; /* Dark pattern */
            --header-text: #aebac1;
            --surface: #202c33;
            --text-primary: #e9edef;
            --text-secondary: #8696a0;
            --msg-sent: #005c4b;
            --msg-received: #202c33;
            --input-bg: #2a3942;
        }

        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Roboto', sans-serif; background-color: var(--bg-color); height: 100vh; display: flex; justify-content: center; overflow: hidden; }
        #app { width: 100%; max-width: 450px; background: var(--surface); display: flex; flex-direction: column; height: 100%; position: relative; box-shadow: 0 0 10px rgba(0,0,0,0.2); }
        
        /* HEADER */
        header { background-color: var(--primary); color: var(--header-text); padding: 10px 15px; display: flex; align-items: center; gap: 15px; height: 60px; z-index: 10; transition: 0.3s; }
        #back-btn { display: none; background: none; border: none; color: var(--header-text); font-size: 22px; cursor: pointer; }
        .header-info { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .header-title { font-weight: bold; font-size: 18px; }
        .header-status { font-size: 13px; opacity: 0.8; height: 16px; }
        
        /* Theme Toggle */
        #theme-btn { background: none; border: none; font-size: 20px; cursor: pointer; color: var(--header-text); }

        .screen { display: none; flex-direction: column; height: 100%; flex: 1; }
        .active { display: flex; }

        /* Gƒ∞Rƒ∞≈û EKRANI */
        #login-screen { justify-content: center; align-items: center; padding: 30px; background: var(--input-bg); color: var(--text-primary); }
        input { width: 100%; padding: 15px; margin-bottom: 15px; border: 1px solid var(--text-secondary); border-radius: 10px; outline: none; background: var(--surface); color: var(--text-primary); }
        .btn { background: #008069; color: white; border: none; padding: 15px; border-radius: 10px; cursor: pointer; width: 100%; font-weight: bold; font-size: 16px; }

        /* KULLANICI Lƒ∞STESƒ∞ */
        #user-list { flex: 1; overflow-y: auto; background: var(--surface); }
        
        /* Benim Durumum Kƒ±smƒ± */
        .my-profile { padding: 15px; background: var(--surface); border-bottom: 1px solid var(--input-bg); display: flex; align-items: center; gap: 15px; cursor: pointer; }
        
        .user-item { padding: 15px; border-bottom: 1px solid var(--input-bg); cursor: pointer; display: flex; align-items: center; gap: 15px; transition: 0.2s; }
        .user-item:hover { background: var(--input-bg); }
        
        .avatar-container { position: relative; }
        .avatar { width: 50px; height: 50px; background: #667781; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 22px; }
        .status-dot { position: absolute; bottom: 2px; right: 2px; width: 13px; height: 13px; border-radius: 50%; border: 2px solid var(--surface); background: #ccc; }
        .online { background: #25d366; }
        
        .user-info { flex: 1; }
        .user-name { font-weight: bold; font-size: 17px; color: var(--text-primary); }
        .user-status { font-size: 14px; color: var(--text-secondary); margin-top: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* SOHBET EKRANI */
        #chat-container { flex: 1; overflow-y: auto; padding: 15px; background: var(--chat-bg); background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); display: flex; flex-direction: column; gap: 8px; }
        [data-theme="dark"] #chat-container { opacity: 0.9; }

        .message-group { max-width: 80%; display: flex; flex-direction: column; position: relative; }
        .message { padding: 8px 10px; border-radius: 8px; font-size: 15px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); word-wrap: break-word; color: var(--text-primary); position: relative; min-width: 80px; }
        
        .sent { align-self: flex-end; background-color: var(--msg-sent); border-top-right-radius: 0; }
        .received { align-self: flex-start; background-color: var(--msg-received); border-top-left-radius: 0; }

        .reply-context { background: rgba(0,0,0,0.05); border-left: 4px solid var(--primary); padding: 5px; margin-bottom: 5px; border-radius: 4px; font-size: 12px; color: var(--text-secondary); }

        .msg-meta { display: flex; justify-content: flex-end; align-items: center; gap: 4px; margin-top: 2px; }
        .msg-time { font-size: 11px; color: var(--text-secondary); }
        .msg-tick { font-size: 14px; color: #53bdeb; display: none; } /* Mavi Tƒ±k */
        .sent .msg-tick { display: inline; }

        /* Mesaj Men√ºs√º (Sil/Yanƒ±tla) */
        .msg-options { display: none; position: absolute; top: -30px; background: var(--surface); padding: 5px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 100; font-size: 12px; }
        .msg-options button { background: none; border: none; color: var(--text-primary); padding: 5px 10px; cursor: pointer; }
        .message:active .msg-options, .message:focus .msg-options { display: flex; gap: 5px; } 

        /* Gƒ∞Rƒ∞≈û ALANI */
        .input-wrapper { background: var(--input-bg); padding: 5px 10px; }
        .reply-preview { background: var(--surface); padding: 10px; border-left: 4px solid var(--primary); color: var(--text-primary); display: none; justify-content: space-between; align-items: center; font-size: 13px; margin-bottom: 5px; border-radius: 5px; }
        
        .input-area { display: flex; gap: 8px; align-items: center; padding-bottom: 5px; }
        #msgInput { flex: 1; border-radius: 25px; border: none; padding: 10px 15px; font-size: 16px; margin: 0; }
        .send-btn { width: 45px; height: 45px; border-radius: 50%; background: #008069; color: white; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; }
    </style>
</head>
<body>

<div id="app">
    <header>
        <button id="back-btn" onclick="goBack()">‚Üê</button>
        <div class="header-info">
            <span id="header-title" class="header-title">VyxChat</span>
            <span id="header-status" class="header-status"></span>
        </div>
        <button id="theme-btn" onclick="toggleTheme()">üåô</button>
    </header>

    <div id="login-screen" class="screen active">
        <h2 style="color: #008069; margin-bottom: 20px;">VyxChat Pro</h2>
        <input type="text" id="usernameInput" placeholder="Adƒ±nƒ±z nedir?">
        <button class="btn" onclick="login()">Giri≈ü Yap</button>
    </div>

    <div id="users-screen" class="screen">
        <div class="my-profile" onclick="editStatus()">
            <div class="avatar-container">
                <div class="avatar" id="my-avatar">?</div>
                <div class="status-dot online"></div>
            </div>
            <div class="user-info">
                <div class="user-name">Durumum</div>
                <div class="user-status" id="my-status-text">M√ºsait ‚úèÔ∏è</div>
            </div>
        </div>
        <div style="padding: 10px; font-size: 13px; color: var(--text-secondary); background: var(--input-bg);">Kƒ∞≈ûƒ∞LER</div>
        <div id="user-list"></div>
    </div>

    <div id="chat-screen" class="screen">
        <div id="chat-container"></div>
        
        <div class="input-wrapper">
            <div id="reply-preview" class="reply-preview">
                <span id="reply-text">Mesaj...</span>
                <button onclick="cancelReply()" style="background:none; border:none; color:red; font-weight:bold;">X</button>
            </div>
            
            <div class="input-area">
                <input type="text" id="msgInput" placeholder="Mesaj yaz..." autocomplete="off">
                <button class="send-btn" onclick="sendMessage()">‚û§</button>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, setDoc, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- AYARLAR ---
    const firebaseConfig = {
        apiKey: "AIzaSyDo3zkxE-4_V6qs6FQ21_x523gul5EaP7U",
        authDomain: "rumlinx.firebaseapp.com",
        projectId: "rumlinx",
        storageBucket: "rumlinx.firebasestorage.app",
        messagingSenderId: "107571707229",
        appId: "1:107571707229:web:1be9f876588c4197b8bcb4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let myName = "";
    let chatPartner = "";
    let chatId = "";
    let replyingTo = null; // Yanƒ±tlanan mesajƒ± tutar
    let typingTimeout;

    // --- TEMA AYARLARI ---
    window.toggleTheme = () => {
        const current = document.documentElement.getAttribute("data-theme");
        const next = current === "dark" ? "light" : "dark";
        document.documentElement.setAttribute("data-theme", next);
        document.getElementById('theme-btn').innerText = next === "dark" ? "‚òÄÔ∏è" : "üåô";
    };

    // --- 1. Gƒ∞Rƒ∞≈û ---
    window.login = async () => {
        myName = document.getElementById('usernameInput').value.trim();
        if (!myName) return alert("ƒ∞sim giriniz!");

        // Kullanƒ±cƒ±yƒ± kaydet (Durum: M√ºsait varsayƒ±lan)
        await setDoc(doc(db, "users", myName), { 
            username: myName, 
            isOnline: true, 
            status: "M√ºsait",
            typingTo: null 
        }, { merge: true });

        document.getElementById('my-avatar').innerText = myName[0].toUpperCase();
        
        // √áƒ±kƒ±≈üta offline yap
        window.addEventListener('beforeunload', () => {
            updateDoc(doc(db, "users", myName), { isOnline: false });
        });

        showScreen('users-screen');
        listenToUsers();
    };

    // --- 2. DURUM G√úNCELLEME ---
    window.editStatus = async () => {
        const newStatus = prompt("Yeni Durumunuz:", "M√ºsait");
        if (newStatus) {
            await updateDoc(doc(db, "users", myName), { status: newStatus });
            document.getElementById('my-status-text').innerText = newStatus + " ‚úèÔ∏è";
        }
    };

    // --- 3. KULLANICILAR ---
    function listenToUsers() {
        onSnapshot(collection(db, "users"), (snapshot) => {
            const list = document.getElementById('user-list');
            list.innerHTML = "";
            snapshot.forEach((docSnap) => {
                const user = docSnap.data();
                if (user.username !== myName) {
                    list.innerHTML += `
                        <div class="user-item" onclick="startChat('${user.username}')">
                            <div class="avatar-container">
                                <div class="avatar">${user.username[0].toUpperCase()}</div>
                                <div class="status-dot ${user.isOnline ? 'online' : ''}"></div>
                            </div>
                            <div class="user-info">
                                <div class="user-name">${user.username}</div>
                                <div class="user-status">${user.status || 'M√ºsait'}</div>
                            </div>
                        </div>`;
                } else {
                    // Kendi durumumu g√ºncelle
                    document.getElementById('my-status-text').innerText = (user.status || 'M√ºsait') + " ‚úèÔ∏è";
                }
            });
        });
    }

    // --- 4. SOHBET BA≈ûLAT ---
    window.startChat = (partner) => {
        chatPartner = partner;
        chatId = [myName, chatPartner].sort().join("_");
        
        showScreen('chat-screen');
        document.getElementById('header-title').innerText = chatPartner;
        document.getElementById('header-status').innerText = "";
        document.getElementById('back-btn').style.display = 'block';
        
        listenToMessages();
        listenToPartnerStatus();
    };

    // --- 5. MESAJ G√ñNDERME ---
    // Yazƒ±yor... √∂zelliƒüi i√ßin
    const msgInput = document.getElementById('msgInput');
    msgInput.addEventListener('input', () => {
        updateDoc(doc(db, "users", myName), { typingTo: chatPartner });
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            updateDoc(doc(db, "users", myName), { typingTo: null });
        }, 2000); // 2 saniye yazmazsa durdu say
    });

    // Enter tu≈üu ile g√∂nderme
    msgInput.addEventListener("keypress", (e) => {
        if(e.key === 'Enter') sendMessage();
    });

    window.sendMessage = async () => {
        const text = msgInput.value.trim();
        if (text && chatId) {
            await addDoc(collection(db, "messages"), {
                chatId: chatId,
                sender: myName,
                text: text,
                replyTo: replyingTo ? replyingTo : null, // Yanƒ±tlanƒ±yorsa ekle
                createdAt: serverTimestamp()
            });
            msgInput.value = "";
            cancelReply();
            updateDoc(doc(db, "users", myName), { typingTo: null });
        }
    };

    // --- 6. MESAJLARI Dƒ∞NLE (Zaman, Yanƒ±t, Silme) ---
    function listenToMessages() {
        onSnapshot(collection(db, "messages"), (snapshot) => {
            const container = document.getElementById('chat-container');
            let msgs = [];
            snapshot.forEach(doc => msgs.push({ id: doc.id, ...doc.data() })); // ID'yi de al

            msgs.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
            
            container.innerHTML = "";
            msgs.forEach(msg => {
                if (msg.chatId === chatId) {
                    const isMe = msg.sender === myName;
                    
                    // Saat formatƒ± (14:30)
                    let timeStr = "";
                    if(msg.createdAt) {
                        const date = new Date(msg.createdAt.seconds * 1000);
                        timeStr = date.getHours().toString().padStart(2,'0') + ":" + date.getMinutes().toString().padStart(2,'0');
                    }

                    // Yanƒ±t kutusu HTML'i
                    let replyHtml = "";
                    if (msg.replyTo) {
                        replyHtml = `<div class="reply-context">
                            <strong>${msg.replyTo.sender}</strong>: ${msg.replyTo.text}
                        </div>`;
                    }

                    // Mesaj HTML'i
                    container.innerHTML += `
                        <div class="message ${isMe ? 'sent' : 'received'}" onclick="showOptions(this, '${msg.id}', '${msg.sender}', '${msg.text}')">
                            ${replyHtml}
                            ${msg.text}
                            <div class="msg-meta">
                                <span class="msg-time">${timeStr}</span>
                                <span class="msg-tick">‚úì‚úì</span>
                            </div>
                            <div class="msg-options" id="opt-${msg.id}">
                                <button onclick="setReply('${msg.sender}', '${msg.text}')">‚Ü©Ô∏è Yanƒ±tla</button>
                                ${isMe ? `<button onclick="deleteMsg('${msg.id}')" style="color:red">üóëÔ∏è Sil</button>` : ''}
                            </div>
                        </div>`;
                }
            });
            container.scrollTop = container.scrollHeight;
        });
    }

    // --- 7. EKSTRA FONKSƒ∞YONLAR ---
    
    // Partnerin Yazƒ±yor... ve Online durumunu dinle
    function listenToPartnerStatus() {
        onSnapshot(doc(db, "users", chatPartner), (doc) => {
            if(doc.exists()) {
                const data = doc.data();
                const statusElem = document.getElementById('header-status');
                
                if (data.typingTo === myName) {
                    statusElem.innerText = "yazƒ±yor...";
                    statusElem.style.color = "#25d366";
                } else if (data.isOnline) {
                    statusElem.innerText = "√áevrimi√ßi";
                    statusElem.style.color = "white";
                } else {
                    statusElem.innerText = "Son g√∂r√ºlme: " + (data.lastSeen ? new Date(data.lastSeen.seconds*1000).toLocaleTimeString().slice(0,5) : "");
                    statusElem.style.color = "#ddd";
                }
            }
        });
    }

    // Mesaj Se√ßeneklerini G√∂ster (Basit Toggle)
    window.showOptions = (el, id, sender, text) => {
        // Mobilde tƒ±klayƒ±nca men√º a√ßƒ±lmasƒ± i√ßin basit mantƒ±k
        // Ger√ßek uygulamada long-press kullanƒ±lƒ±r ama web i√ßin click yeterli
        const opt = document.getElementById(`opt-${id}`);
        const allOpts = document.querySelectorAll('.msg-options');
        allOpts.forEach(o => { if(o !== opt) o.style.display = 'none'; }); // Diƒüerlerini kapat
        
        opt.style.display = opt.style.display === 'flex' ? 'none' : 'flex';
        // Olayƒ±n yukarƒ± ta≈ümasƒ±nƒ± engelleme (basit√ße)
        setTimeout(() => opt.style.display = 'none', 4000); // 4 saniye sonra otomatik kapan
    };

    // Mesaj Sil
    window.deleteMsg = async (id) => {
        if(confirm("Mesajƒ± herkesten silmek istiyor musun?")) {
            await deleteDoc(doc(db, "messages", id));
        }
    };

    // Yanƒ±tla
    window.setReply = (sender, text) => {
        replyingTo = { sender, text };
        document.getElementById('reply-preview').style.display = 'flex';
        document.getElementById('reply-text').innerText = `${sender}: ${text.substring(0, 20)}...`;
        document.getElementById('msgInput').focus();
    };

    window.cancelReply = () => {
        replyingTo = null;
        document.getElementById('reply-preview').style.display = 'none';
    };

    // Ekran Deƒüi≈ütirme
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    window.goBack = () => {
        showScreen('users-screen');
        document.getElementById('header-title').innerText = "VyxChat";
        document.getElementById('header-status').innerText = "";
        document.getElementById('back-btn').style.display = 'none';
    };

</script>
</body>
</html>
